<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>

    <!-- Normalize bad hashes -->
    <script>
      (function () {
        var h = location.hash || "";
        if (h.indexOf("/access_token=") === 1) return location.replace(location.pathname + "#" + h.slice(2));
        if (h.indexOf("#access_token=") === 1) return location.replace(location.pathname + "#" + h.slice(2));
      })();
    </script>

    <!-- Bridge: persist token then reload to "#/" -->
    <script>
      (function () {
        var ORIGIN = location.origin; // https://connecttechnologyteam.github.io
        function save(tok){
          if(!tok) return;
          var p = JSON.stringify({ token: tok, provider: "github" });
          try {
            localStorage.setItem("netlify-cms.user", p);
            localStorage.setItem("decap-cms-user", p);
            localStorage.setItem("decap-cms-auth", p);
          } catch {}
        }
        // A) token via hash
        var m = (location.hash || "").match(/access_token=([^&]+)/);
        if (m) {
          save(decodeURIComponent(m[1]));
          return location.replace(location.pathname + "#/");
        }
        // B) token via postMessage (from popup)
        window.addEventListener("message", function (ev) {
          if (ev.origin !== ORIGIN) return; // only accept from same origin
          var s = String(ev.data || "");
          if (!s.startsWith("authorization:github:")) return;
          var rest = s.replace("authorization:github:", "");
          var tok = rest;
          try { if (rest.startsWith("{")) tok = JSON.parse(rest).token; } catch {}
          save(tok);
          location.replace(location.pathname + "#/");
        }, false);
      })();
    </script>

    <style>
      html,body{height:100%;margin:0}
      body{display:grid;place-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f7f7f9}
      .boot{color:#667;opacity:.75;font-size:12px;position:fixed;top:8px;left:50%;transform:translateX(-50%)}
    </style>
  </head>
  <body>
    <div class="boot">Loading Content Managerâ€¦</div>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
