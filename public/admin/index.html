<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>

    <script>
      (function () {
        // --- helpers ---
        function persistToken(tok) {
          if (!tok) return;
          var payload = JSON.stringify({ token: tok, provider: "github" });
          try {
            // Các key phổ biến mà Decap/Netlify CMS từng dùng
            localStorage.setItem("netlify-cms.user", payload);
            localStorage.setItem("decap-cms-user", payload);
            localStorage.setItem("decap-cms-auth", payload);
          } catch (e) {}
        }
        function gotoRoot() {
          // Quay về shell của CMS (#/) để dashboard render
          location.replace(location.pathname + "#/");
        }

        // --- 1) Chuẩn hoá hash & bắt token qua URL ---
        var h = location.hash || "";
        // Fix trường hợp "#/access_token=..." => "#access_token=..."
        if (h.indexOf("/access_token=") === 1) {
          location.replace(location.pathname + "#" + h.slice(2));
          return;
        }
        // Nếu đã có token trong hash thì lưu & quay về "#/"
        var m = h.match(/access_token=([^&]+)/);
        if (m) {
          persistToken(decodeURIComponent(m[1]));
          gotoRoot();
          return;
        }

        // --- 2) Nhận token qua postMessage từ popup callback ---
        // Chấp nhận cả alias production và preview domain của Vercel cho project này
        var allowProviderOrigin = function (origin) {
          return /^https:\/\/devnotes-oauth-provider(-[a-z0-9-]+)?\.vercel\.app$/.test(origin);
        };

        window.addEventListener(
          "message",
          function (ev) {
            try {
              if (!allowProviderOrigin(ev.origin)) return; // chỉ nhận từ OAuth provider
              var s = String(ev.data || "");
              if (!s.startsWith("authorization:github:")) return;
              var rest = s.slice("authorization:github:".length);
              var tok = rest;
              if (rest[0] === "{") tok = JSON.parse(rest).token;
              persistToken(tok);
              gotoRoot();
            } catch (e) {}
          },
          false
        );
      })();
    </script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { display: grid; place-items: center; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f7f7f9; }
      .boot { color: #667; opacity: .75; font-size: 12px; position: fixed; top: 8px; left: 50%; transform: translateX(-50%); }
    </style>
  </head>
  <body>
    <div class="boot">Loading Content Manager…</div>
    <!-- KHÔNG manual init; để Decap tự đọc config.yml -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  </body>
</html>
