<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>

    <script>
      (function () {
        var h = location.hash || "";
        if (h.indexOf("/access_token=") === 1) return location.replace(location.pathname + "#" + h.slice(2));
        if (h.indexOf("#access_token=") === 1) return; // let CMS handle legacy format
      })();
    </script>

    <script>
      (function () {
        var PROVIDER_ORIGIN = 'https://devnotes-oauth-provider.vercel.app';
        var SELF_ORIGIN = location.origin;
        function log(){ try { console.log.apply(console, arguments); } catch(_) {} }
        function persist(tok){
          if(!tok) return;
          var p = JSON.stringify({ token: tok, provider: "github" });
          try {
            localStorage.setItem("netlify-cms.user", p);
            localStorage.setItem("decap-cms-user", p);
            localStorage.setItem("decap-cms-auth", p);
            log('[admin] token saved');
          } catch(e){ log('[admin] save error', e); }
        }
        function rebroadcast(tok){
          if(!tok) return;
          var m1 = 'authorization:github:' + JSON.stringify({ token: tok, provider: 'github' });
          var m2 = 'authorization:github:' + JSON.stringify({ token: tok });
          var m3 = 'authorization:github:' + tok;
          var n=0; var iv=setInterval(function(){
            try { window.postMessage(m1, SELF_ORIGIN); } catch(_) {}
            try { window.postMessage(m2, SELF_ORIGIN); } catch(_) {}
            try { window.postMessage(m3, SELF_ORIGIN); } catch(_) {}
            if(++n>=25) clearInterval(iv);
          },120);
        }
        function getStoredToken(){
          var raw = localStorage.getItem('decap-cms-user') || localStorage.getItem('netlify-cms.user') || localStorage.getItem('decap-cms-auth');
          if(!raw) return null;
          try { return JSON.parse(raw).token || raw; } catch { return raw; }
        }
        // If token already stored (from previous login), rebroadcast so CMS picks it up
        (function(){ var t = getStoredToken(); if (t){ log('[admin] rebroadcast stored token'); rebroadcast(t); } })();

        // Listen for token from popup and rebroadcast without reloading
        window.addEventListener("message", function (ev) {
          if (ev.origin !== PROVIDER_ORIGIN && ev.origin !== SELF_ORIGIN) return;
          var s = String(ev.data || "");
          if (!s.startsWith("authorization:github:")) return;
          var rest = s.replace("authorization:github:", "");
          var tok = rest;
          try { if (rest.startsWith("{")) tok = JSON.parse(rest).token; } catch(e){ log('[admin] parse error', e); }
          log('[admin] received token from', ev.origin);
          persist(tok);
          rebroadcast(tok);
        }, false);
      })();
    </script>

    <style>
      html,body{height:100%;margin:0}
      body{display:grid;place-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f7f7f9}
      .boot{color:#667;opacity:.75;font-size:12px;position:fixed;top:8px;left:50%;transform:translateX(-50%)}
    </style>
  </head>
  <body>
    <div class="boot">Loading Content Managerâ€¦</div>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
