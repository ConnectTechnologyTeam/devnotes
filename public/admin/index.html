<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>

    <script>window.CMS_MANUAL_INIT = true;</script>

    <!-- 1) Normalize bad hashes early: "/#/access_token=..." -> "#access_token=..." -->
    <script>
      (function () {
        var h = window.location.hash || "";
        if (h.indexOf("/access_token=") === 1) {
          var fixed = "#" + h.slice(2);
          window.location.replace(window.location.pathname + fixed);
          return;
        }
        if (h.indexOf("#access_token=") === 1) {
          var fixed2 = "#" + h.slice(2);
          window.location.replace(window.location.pathname + fixed2);
          return;
        }
      })();
    </script>

    <!-- 2) Bridge: receive OAuth token via postMessage or URL hash, persist to localStorage, then reload to "#/" -->
    <script>
      (function () {
        function saveToken(tok) {
          if (!tok) return;
          try {
            var payload = JSON.stringify({ token: tok, provider: "github" });
            localStorage.setItem("netlify-cms.user", payload);
            localStorage.setItem("decap-cms-user", payload);
            localStorage.setItem("decap-cms-auth", payload);
          } catch (e) {}
        }

        var m = (window.location.hash || "").match(/access_token=([^&]+)/);
        if (m) {
          saveToken(decodeURIComponent(m[1]));
          window.location.replace(window.location.pathname + "#/");
        }

        window.addEventListener(
          "message",
          function (ev) {
            try {
              var data = String(ev.data || "");
              if (!data.startsWith("authorization:github:")) return;
              var rest = data.replace("authorization:github:", "");
              var tok = rest;
              if (rest.startsWith("{")) tok = JSON.parse(rest).token;
              saveToken(tok);
              window.location.replace(window.location.pathname + "#/");
            } catch (e) {}
          },
          false
        );
      })();
    </script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { display: grid; place-items: center; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f7f7f9; }
      .boot { color: #667; opacity: .75; font-size: 12px; position: fixed; top: 8px; left: 50%; transform: translateX(-50%); }
    </style>
  </head>
  <body>
    <div class="boot">Loading Content Managerâ€¦</div>
    <!-- 3) Load Decap AFTER the bridge -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- 4) Manual init: if token exists, bootstrap CMS with it to bypass login -->
    <script>
      (function () {
        function getToken() {
          var raw = localStorage.getItem('decap-cms-user') || localStorage.getItem('netlify-cms.user') || localStorage.getItem('decap-cms-auth');
          if (!raw) return null;
          try { return JSON.parse(raw).token || raw; } catch { return raw; }
        }
        function initWithToken(tok) {
          if (!window.CMS || !tok) return;
          // Read config.yml at runtime is default; we only override backend token
          const backend = {
            name: 'github',
            repo: 'ConnectTechnologyTeam/devnotes',
            branch: 'main',
            base_url: 'https://devnotes-oauth-provider.vercel.app',
            auth_endpoint: '/api/auth',
            token: tok,
          };
          window.CMS.init({ config: { backend } });
        }
        function initNormally() {
          if (!window.CMS) return;
          window.CMS.init();
        }
        var tok = getToken();
        if (tok) {
          // Try init with token; if it fails (no permissions), fall back to normal init
          try { initWithToken(tok); } catch (e) { initNormally(); }
        } else {
          initNormally();
        }
      })();
    </script>
  </body>
</html>
